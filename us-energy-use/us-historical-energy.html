<!DOCTYPE html>
<html>
  <head>
    <title>US Historical Energy Consumption</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
	<!--<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="jquery.tipsy.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" href="http://onehackoranother.com/projects/jquery/tipsy/stylesheets/tipsy.css" type="text/css" title="no title" charset="utf-8"/> -->
<style type="text/css">
body { font: 11px sans-serif; }

.axis path, line { stroke: #000; fill:none; shape-rendering: crispEdges;}

.arc path {
  stroke: #fff;
}

div#stack { width: 550px; float:left; }
div#pie { width: 350px; float:left; }
</style>
</head>
<body>
<div id="stack">
</div>
<div id="pie">
</div>

<script type="text/javascript">
	var margin = {t:20, r:20, b:20, l:30 },
		w1 = 500 - margin.l,
		w2 = 300 - margin.r,
		h = 350 - margin.t - margin.b,
		x = d3.time.scale().range([0, w1]),
		y = d3.scale.linear().range([h, 0]).domain([0, 110]),
		color = d3.scale.ordinal().range(["#3A5A64", "#A81F5E", "#9BCFF4", "#DABD49", "#A78149", "#49DA8D"]),
		formatTime = d3.time.format("%Y").parse;
	
	var dataChange,
		latest,
		data;
		
	var	radius = Math.min((w1 + w2), h) / 2;
		
	var stacked = d3.select("#stack").append("svg")
		.attr("width", w1 + margin.l)
		.attr("height", h + margin.t + margin.b)
	   .append("g")
		.attr("transform", "translate(" + margin.l + "," + margin.t + ")");
		
	var krispy = d3.select("#pie").append("svg")
		.attr("width", w2 + margin.r)
		.attr("height", h + margin.t + margin.b)
	   .append("g")
		.attr("transform", "translate(150," + (h/2 + margin.t) + ")");
	
	var xAxis = d3.svg.axis()
				.scale(x)
				.orient("bottom");
				
	var yAxis = d3.svg.axis()
				.scale(y)
				.orient("left");
				
	var stack = d3.layout.stack()
				.values(function(d) { return d.values; });
	
	var area = d3.svg.area().interpolate("linear")
				.x(function(d) { return x(d.year); })
				.y0(function(d) { return y(d.y0); })
				.y1(function(d) { return y(d.y + d.y0); })
				
	var arc = d3.svg.arc()
				.outerRadius(radius - 20)
				.innerRadius(radius - 60);
				
	var pie = d3.layout.pie()
		.sort(null)
		.value(function(d) { return d.values; });
	
	stacked.append("g")
		.attr("class", "y axis")
		.call(yAxis);
		
				
d3.csv("us-historical-energy.csv", function(csv) {	
	data = csv;
	
	csv.forEach(function(d) { 
		d.Year = formatTime(d.Year);
	});
	
	var latest = 2;
	
	function update() {
		dataChange = csv.slice(0, latest)
		latest++;
		if (latest < csv.length) {
		redraw();
			setTimeout(update, 500);
			
		};
	};
	update();
});
	
function redraw() {
	color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year" && key !== "sourcesPie"; }))
	
	var sourcesStack = stack(color.domain().map(function(name) {
	  return {
		name: name,
		values: data.map(function(d) { 
		  return { year: d.Year, y: +d[name] };
		  })
	  };
	}));
	
	x.domain([d3.min(dataChange, function(d) { return d.Year; }), d3.max(dataChange, function(d) { return d.Year; })]);

	var stacks = stacked.selectAll(".sources")
		.data(sourcesStack)
	   
	var stacksEnter = stacks.enter().append("g")
	    .attr("class", "sources")
		
	stacksEnter.append("path")
		.attr("class", "area")
		.attr("d", function(d) { return area(d.values); })
		.style("fill", function(d) { return color(d.name); })
		
	stacks.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + h + ")");
	
	var stacksUpdate = d3.transition(stacks)
	
	stacksUpdate.transition().select("path").duration(500)
		.attr("d", function(d) { return area(d.values); })
	
	d3.transition().select(".x.axis").duration(500).call(xAxis)
	
	
	// the donut
	
	data.forEach(function(d) {
      d.sourcesPie = color.domain().map(function(name) {
        return {name: name, values: +d[name]};
      });
	});
	
	var donut = krispy.selectAll(".arc")
		.data(pie(dataChange[dataChange.length - 1].sourcesPie))
	
	var donutEnter = donut.enter().append("g")
		.attr("class", "arc")
		.append("path")
		.attr("class", "donutPath")
		.attr("d", arc)
		.each(function(d) { this._current = d; })
		.style("fill", function(d) { return color(d.data.name); });
		
	donutEnter.append("svg:text")
		.attr("transform", function(d) {
        d.outerRadius = radius + 50; // Set Outer Coordinate
        d.innerRadius = radius + 45; // Set Inner Coordinate
		return "translate(" + arc.centroid(d) + ")"; })
		.attr("dy", ".35em")
		.style("text-anchor", "middle")
		.text(function(d) { return d.data.name; });
		
	var donutUpdate = d3.transition(donut)

	donutUpdate.transition().select("path").duration(500)
		.attrTween("d", arcTween)
	};
	
	donutUpdate.transition().select("text")
		.attr("transform", function(d) {
        d.outerRadius = radius + 50; // Set Outer Coordinate
        d.innerRadius = radius + 45; // Set Inner Coordinate
		return "translate(" + arc.centroid(d) + ")"; })
	
	function arcTween(a) {
		  var i = d3.interpolate(this._current, a);
		  this._current = i(0);
		  return function(t) {
			return arc(i(t));
		  };
		}
</script>
</body>
</html>