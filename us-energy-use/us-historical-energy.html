<!DOCTYPE html>
<html>
  <head>
    <title>US Historical Energy Consumption</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
	<!--<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="jquery.tipsy.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" href="http://onehackoranother.com/projects/jquery/tipsy/stylesheets/tipsy.css" type="text/css" title="no title" charset="utf-8"/> -->
<style type="text/css">
body { font: 11px sans-serif; }

.axis path, line { stroke: #000; fill:none; shape-rendering: crispEdges;}

.arc path {
  stroke: #fff;
}

div#stack { width: 550px; float:left; }
div#pie { width: 350px; float:left; }
</style>
</head>
<body>
<div id="stack">
</div>
<div id="pie">
</div>

<script type="text/javascript">
	var margin = {t:20, r:20, b:20, l:30 },
		w1 = 500 - margin.l,
		w2 = 300 - margin.r,
		h = 350 - margin.t - margin.b,
		x = d3.time.scale().range([0, w1]),
		y = d3.scale.linear().range([h, 0]),
		color = d3.scale.category10(),
		formatTime = d3.time.format("%Y").parse;
		
	var	radius = Math.min((w1 + w2), h) / 2;
		
	var stacked = d3.select("#stack").append("svg")
		.attr("width", w1 + margin.l)
		.attr("height", h + margin.t + margin.b)
	   .append("g")
		.attr("transform", "translate(" + margin.l + "," + margin.t + ")");
		
	var krispy = d3.select("#pie").append("svg")
		.attr("width", w2 + margin.r)
		.attr("height", h + margin.t + margin.b)
	   .append("g")
		.attr("transform", "translate(150," + (h/2 + margin.t) + ")");
	
	var xAxis = d3.svg.axis()
				.scale(x)
				.orient("bottom");
				
	var yAxis = d3.svg.axis()
				.scale(y)
				.orient("left");
				
	var stack = d3.layout.stack()
				.values(function(d) { return d.values; });
	
	var area = d3.svg.area()
				.x(function(d) { return x(d.year); })
				.y0(function(d) { return y(d.y0); })
				.y1(function(d) { return y(d.y + d.y0); });	
				
	var arc = d3.svg.arc()
				.outerRadius(radius - 20)
				.innerRadius(radius - 60);
				
d3.csv("us-historical-energy.csv", function(error, data) { 
	data.forEach(function(d) { 
		d.Year = formatTime(d.Year);
	});
	
	color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year"; }))
	
	sources = color.domain()
	console.log(sources)
	var sourcesStack = stack(color.domain().map(function(name) {
		return {
			name: name,
			values: data.map(function(d) { 
				return { year: d.Year, y: +d[name] };
			})
		};
	}));
	
	x.domain(d3.extent(data, function(d) { return d.Year; }));
	y.domain([0, d3.max(sourcesStack, function(c) { return d3.max(c.values, function(v) { return v.y + v.y0; }); })]); 
	
	console.log(data)
	
	var group = stacked.selectAll(".sources")
		.data(sourcesStack)
	   .enter().append("g")
	    .attr("class", "sources")
		
	group.append("path")
		.attr("class", "area")
		.attr("d", function(d) { return area(d.values); })
		.style("fill", function(d) { return color(d.name); })
		
	stacked.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + h + ")")
		.call(xAxis)
	
	stacked.append("g")
		.attr("class", "y axis")
		.call(yAxis)
		
	// the donut
	data.forEach(function(d) {
      d.sourcesPie = color.domain().map(function(name) {
      return {name: name, values: +d[name]};
    });
  });
	
	var pie = d3.layout.pie()
				.sort(null)
				.value(function(d) { return d.values; });
	
	var donut = krispy.selectAll(".arc")
		.data(pie(data[data.length -1].sourcesPie))
	   .enter().append("g")
		.attr("class", "arc");
		
	donut.append("path")
		.attr("d", arc)
		.style("fill", function(d) { return color(d.data.name); })
})
</script>
</body>
</html>