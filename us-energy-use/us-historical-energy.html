<!DOCTYPE html>
<html>
  <head>
    <title>US Historical Energy Consumption</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
	<!--<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="jquery.tipsy.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" href="http://onehackoranother.com/projects/jquery/tipsy/stylesheets/tipsy.css" type="text/css" title="no title" charset="utf-8"/> -->
<style type="text/css">
body { font-size: 11px; font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; }

.axis path, line { stroke: #000; fill:none; shape-rendering: crispEdges;}

line.tick { stroke: #cccccc; opacity:.4; }

.arc path {
  stroke: #fff;
}

div#stack { width: 550px; float:left; }
div#pie { width: 350px; float:left; }
.yLabels { stroke: none; font-size: 1em; fill:#191919; }
.donutLabels { stroke: none; font-size: 1em; fill:white; }

</style>
</head>
<body>
<div id="stack">
</div>
<div id="pie">
</div>

<script type="text/javascript">
	var margin = {t:20, r:20, b:20, l:30 },
		w1 = 550 - margin.l - margin.r,
		w2 = 300 - margin.r,
		h = 350 - margin.t - margin.b,
		x = d3.time.scale().range([0, w1 - margin.r]).clamp(true),
		y = d3.scale.linear().range([h, 0]).domain([0, 110]),
		color = d3.scale.ordinal().range(["#37A36A", "#3A5A64", "#DABD49", "#C78739", "#8AB8D9", "#A81F5E"]),
		formatTime = d3.time.format("%Y").parse;
	
	var dataChange,
		latest,
		data;
		
	var radius = Math.min((w2), h) / 2;
	var labelRadius = radius - 20;
		
	var stacked = d3.select("#stack").append("svg")
		.attr("width", w1 + margin.l + margin.r)
		.attr("height", h + margin.t + margin.b)
	   .append("g")
		.attr("transform", "translate(" + margin.l + "," + margin.t + ")");
		
	var krispy = d3.select("#pie").append("svg")
		.attr("width", w2 + margin.r + margin.l)
		.attr("height", h + margin.t + margin.b)
	   .append("g")
		.attr("transform", "translate(150," + (h/2 + margin.t) + ")");
	
	var xAxis = d3.svg.axis()
				.scale(x)
				.tickSubdivide(true)
				.orient("bottom");
				
	var yAxis = d3.svg.axis()
				.scale(y)
				.tickSize(-w1+margin.r, 0, 0)
				.orient("left");
				
	var stack = d3.layout.stack()
				.values(function(d) { return d.values; });
	
	var area = d3.svg.area().interpolate("cardinal")
				.x(function(d) { return x(d.year); })
				.y0(function(d) { return y(d.y0); })
				.y1(function(d) { return y(d.y + d.y0); })
				
	var arc = d3.svg.arc()
				.outerRadius(radius - 10)
				.innerRadius(radius - 50);
				
	var pie = d3.layout.pie()
		.sort(null)
		.value(function(d) { return d.values; });
	
	stacked.append("g")
		.attr("class", "y axis")
		.call(yAxis);
		
				
d3.csv("us-historical-energy.csv", function(csv) {	

	data = csv;
	
	data.forEach(function(d) { 
		d.Year = formatTime(d.Year);
	});
	
	var latest = 2;
	
	function update() {
		dataChange = data.slice(0, latest)
		latest++;
		if (latest < data.length) {
		redraw();			
		};
	};
	setInterval(update, 500);
	
	color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year" && key !== "sourcesPie"; }))
	
	var legend = stacked.append("g")
				.attr("class", "legendBox")
	
	var legends = legend.selectAll(".legend")
			.data(color.domain())
		.enter().append("g")
			.attr("class", "legend")
			.attr("transform", function(d, i) { return "translate(10," + (5 + (i * 20)) + ")"; });
			
		legends.append("rect")
			.attr("width", 15)
			.attr("height", 15)
			.style("fill", color)
	
		legends.append("text")
			.attr("x", 20)
			.attr("y", 8)
			.attr("dy", ".35em")
			.text(function(d) { return d; });
});
	
function redraw() {
	
	
	var sourcesStack = stack(color.domain().map(function(name) {
	  return {
		name: name,
		values: data.map(function(d) { 
		  return { year: d.Year, y: +d[name] };
		  })
	  };
	}));
	
	x.domain([d3.min(dataChange, function(d) { return d.Year; }), d3.max(dataChange, function(d) { return d.Year; })]);
	
	var stacks = stacked.selectAll(".sources")
		.data(sourcesStack)
		
	stacks.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + h + ")");
	   
	var stacksEnter = stacks.enter().append("g")
	    .attr("class", "sources")
		
	stacksEnter.append("path")
		.attr("class", "area")
		.attr("d", function(d) { return area(d.values); })
		.style("fill", function(d) { return color(d.name); })
		
	/*stacksEnter.append("text")
		.attr("class", "yLabels")
		.datum(function(d) { return {name: d.name, value: d.values[dataChange.length - 1]}; })
		.attr("transform", function(d) { return "translate(" + (w1 - margin.r) + "," + y(d.value.y) + ")"; })
		.attr("x", 4)
		.attr("dy", ".35em")
		.text(function(d) { return d.name; })
		.style("fill-opacity", function(d) {return d.value==0 ? 1e-6 : 1;});
		
	stacksEnter.append("text")
		.attr("transform", "translate(" + margin.l + "," + margin.t + ")")
		.text(function(d) { return d.Year; })*/
	
	var stacksUpdate = d3.transition(stacks)
	
	stacksUpdate.transition().select("text")
		.attr("transform", function(d) { return "translate(" + (w1 - margin.r) + "," + y(d.values[dataChange.length - 1].y) + ")"; })
		.text(function(d) { return d.name; })
	
	stacksUpdate.transition().select("path").duration(500)
		.attr("d", function(d) { return area(d.values); })
	
	stacksUpdate.select("text")
		.text(function(d) { return d.Year; })
		
	d3.transition().select(".x.axis").duration(500).call(xAxis)
	
	// the donut
	
	data.forEach(function(d) {
      d.sourcesPie = color.domain().map(function(name) {
        return {name: name, values: +d[name]};
      });
	});
	
	var donut = krispy.selectAll(".arc")
		.data(pie(dataChange[dataChange.length - 1].sourcesPie))
			
	var donutEnter = donut.enter().append("g")
		.attr("class", "arc")
	
	var total = d3.sum(dataChange[dataChange.length - 1].sourcesPie, function(d) { return d.values; })
	var formatPercent = d3.format("%.1p")
	console.log(total)
	
	 donutEnter.append("path")
		.attr("class", "donutPath")
		.attr("d", arc)
		.each(function(d) { this._current = d; })
		.style("fill", function(d) { return color(d.data.name); })
	
	donutEnter.append("text")
		.attr("class", "donutLabels")
		.attr("transform", function(d) {
			return "translate(" + arc.centroid(d) + ")rotate(" + angle(d) + ")"; })
		.attr("dy", ".35em")
		.attr("text-anchor", "middle")
		.style("fill-opacity", function(d) {return d.value==0 ? 1e-6 : 1;})
		.text(function(d) { 
			return formatPercent(d.data.values/total) });
	 
/*	 donutEnter.append("line")
		.attr("x1", 0)
		.attr("x2", 0)
		.attr("y1", -radius-3)
		.attr("y2", -radius-8)
		.attr("stroke", "gray")
		.attr("transform", function(d) {
			return "rotate(" + (d.startAngle+d.endAngle)/2 * (180/Math.PI) + ")";
		}); */
	  
	function angle(d) {
      var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
      return a > 90 ? a - 180 : a;
    }
	
	var donutUpdate = d3.transition(donut);
	
	donutUpdate.transition().select("text").duration(500)
		.attr("transform", function(d) {
        return "translate(" + arc.centroid(d) + ")rotate(" + angle(d) + ")"; }) 
		.style("fill-opacity", function(d) {return d.value==0 ? 1e-6 : 1;})
		.text(function(d) {
			return formatPercent(d.data.values/total) });
		
	donutUpdate.transition().select("path").duration(500)
		.attrTween("d", arcTween)
		
	function arcTween(a) {
		  var i = d3.interpolate(this._current, a);
		  this._current = i(0);
		  return function(t) {
			return arc(i(t));
		  };
		}
	};
</script>
</body>
</html>